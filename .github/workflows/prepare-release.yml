---
name: Pre-Release
run-name: Build ${{ github.ref_name }} by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to create (e.g., 1.2.3) â€” do NOT prefix with 'v'"
        required: true
        type: string

defaults:
  run:
    shell: bash

jobs:
  prepare:
    name: Validate release inputs (no commits)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Validate and normalize inputs
        id: prep
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          if [[ -z "${TAG}" ]]; then
            echo "No tag provided" >&2
            exit 1
          fi

          # Normalize whitespace
          TAG="${TAG//[[:space:]]/}"

          # Validation: tags MUST NOT start with 'v' and must look like a semantic version
          if [[ "$TAG" =~ ^v ]]; then
            echo "Provided tag '$TAG' is prefixed with 'v'. This repository requires tags without a leading 'v' (e.g., 1.2.3)." >&2
            exit 1
          fi
          if [[ ! "$TAG" =~ ^[0-9]+(\.[0-9]+){0,2}($|[-+]) ]]; then
            echo "Provided tag '$TAG' does not look like a semantic version (e.g., 1.2.3)." >&2
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Ensure tag does not already exist
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail
          git fetch --tags -f
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists. Aborting to avoid overwriting an existing tag." >&2
            exit 1
          fi

      - name: Verify .mvn/maven.config matches the intended tag
        uses: ./.github/actions/verify-tag
        with:
          tag: ${{ steps.prep.outputs.tag }}
          ref: origin/main

      - name: Next steps (manual)
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          echo "Validation succeeded. Proceed with manual tagging and draft release:"
          echo "  git checkout main"
          echo "  git pull --ff-only"
          echo "  git tag -a '${TAG}' -m 'Release ${TAG}'"
          echo "  git push origin 'refs/tags/${TAG}'"
          echo "Then create a draft GitHub Release for ${TAG} (or publish directly) using CHANGELOG.md as needed."
          echo "When you publish the GitHub Release, the Release workflow will build and deploy."
