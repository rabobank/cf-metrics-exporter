---
name: Prepare Release (pre-tag)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to create (e.g., v1.2.3 or 1.2.3)"
        required: true
        type: string

defaults:
  run:
    shell: bash

jobs:
  prepare:
    name: Prepare release commit and tag
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate and normalize inputs
        id: prep
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          if [[ -z "${TAG}" ]]; then
            echo "No tag provided" >&2
            exit 1
          fi

          # Normalize whitespace
          TAG="${TAG//[[:space:]]/}"

          # Basic validation: allow optional leading 'v' and 1-3 numeric segments
          VERSION_NO_V="${TAG#v}"
          if [[ ! "$VERSION_NO_V" =~ ^[0-9]+(\.[0-9]+){0,2}($|[-+]) ]]; then
            echo "Provided tag '$TAG' does not look like a semantic version (e.g., v1.2.3)." >&2
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Ensure tag does not already exist
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail
          git fetch --tags -f
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists. Aborting to avoid overwriting an existing tag." >&2
            exit 1
          fi

      - name: Create release branch from main
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail
          git fetch origin main:main
          git checkout -b "release/${TAG}" main

      - name: Write revision to .mvn/maven.config
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail
          desired_line="-Drevision=${TAG}"
          mkdir -p .mvn
          # Only update if needed
          if [[ -f .mvn/maven.config ]] && grep -qxF "$desired_line" .mvn/maven.config; then
            echo "maven.config already contains ${desired_line}; no file change needed."
          else
            echo "$desired_line" > .mvn/maven.config
          fi

      - name: Commit change if needed
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail
          # Configure Git author identity for CI commits
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .mvn/maven.config
          if ! git diff --cached --quiet; then
            git commit -m "chore(release): set revision to ${TAG}"
          else
            echo "No changes to commit (revision already ${TAG})."
          fi

      - name: Create and push tag
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail
          # Create an annotated tag at the current HEAD (release/<tag>)
          git tag -a "${TAG}" -m "Release ${TAG}"
          # Push both the branch (optional) and the tag
          git push origin "HEAD:refs/heads/release/${TAG}" || true
          git push origin "refs/tags/${TAG}"

      - name: Create draft GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.prep.outputs.tag }}
          name: ${{ steps.prep.outputs.tag }}
          bodyFile: CHANGELOG.md
          draft: true
          allowUpdates: true
          generateReleaseNotes: true

      - name: Next steps
        run: |
          echo "Draft release created for tag '${{ steps.prep.outputs.tag }}'."
          echo "Review the draft release and click 'Publish' when ready."
          echo "On publish, the existing Release workflow will deploy and bump main to the next minor -SNAPSHOT."
