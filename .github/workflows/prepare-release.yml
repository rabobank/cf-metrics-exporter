---
name: Pre-Release
run-name: Build ${{ github.ref_name }} by @${{ github.actor }}

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag to create (e.g., 1.2.3) â€” do NOT prefix with 'v'"
        required: true
        type: string

defaults:
  run:
    shell: bash

jobs:
  prepare:
    name: Validate release inputs (no commits)
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          fetch-depth: 0

      - name: Validate and normalize inputs
        id: prep
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail
          if [[ -z "${TAG}" ]]; then
            echo "No tag provided" >&2
            exit 1
          fi

          # Normalize whitespace
          TAG="${TAG//[[:space:]]/}"

          # Validation: tags MUST NOT start with 'v' and must look like a semantic version
          if [[ "$TAG" =~ ^v ]]; then
            echo "Provided tag '$TAG' is prefixed with 'v'. This repository requires tags without a leading 'v' (e.g., 1.2.3)." >&2
            exit 1
          fi
          if [[ ! "$TAG" =~ ^[0-9]+(\.[0-9]+){0,2}($|[-+]) ]]; then
            echo "Provided tag '$TAG' does not look like a semantic version (e.g., 1.2.3)." >&2
            exit 1
          fi

          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Ensure tag does not already exist
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail
          git fetch --tags -f
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "Tag ${TAG} already exists. Aborting to avoid overwriting an existing tag." >&2
            exit 1
          fi

      - name: Verify .mvn/maven.config matches the intended tag
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          set -euo pipefail

          # Update refs for origin/main without touching the working tree
          git fetch --quiet origin main

          desired_line="-Drevision=${TAG}"
          # Verify the file exists at origin/main without checking out
          if git cat-file -e "origin/main:.mvn/maven.config" 2>/dev/null; then
            # Read entire file and normalize CRLF by removing any \r characters.
            # Newline-agnostic matching: accept either exact single-line match (no trailing newline)
            # or a full-line match among potentially multiple lines.
            content=$(git show "origin/main:.mvn/maven.config" | sed $'s/\r//g')
            # Wrap content with newlines to make line-boundary matching work even if
            # the file lacks a trailing newline.
            wrapped_content=$'\n'"$content"$'\n'
            if [[ "$wrapped_content" == *$'\n'"$desired_line"$'\n'* ]]; then
              echo "OK: .mvn/maven.config at origin/main matches the intended tag (${TAG})."
            else
              echo "ERROR: .mvn/maven.config at origin/main does not contain the expected line: $desired_line" >&2
              echo "Observed contents (normalized for CRLF):" >&2
              { git show "origin/main:.mvn/maven.config" | sed $'s/\r//g'; echo; } >&2 || true
              echo "Please update the file on your branch and commit the change, then re-run this workflow." >&2
              exit 1
            fi
          else
            echo "ERROR: .mvn/maven.config not found at origin/main." >&2
            echo "Ensure the file exists and contains: $desired_line" >&2
            exit 1
          fi

      - name: Next steps (manual)
        env:
          TAG: ${{ steps.prep.outputs.tag }}
        run: |
          echo "Validation succeeded. Proceed with manual tagging and draft release:"
          echo "  git checkout main"
          echo "  git pull --ff-only"
          echo "  git tag -a '${TAG}' -m 'Release ${TAG}'"
          echo "  git push origin 'refs/tags/${TAG}'"
          echo "Then create a draft GitHub Release for ${TAG} (or publish directly) using CHANGELOG.md as needed."
          echo "When you publish the GitHub Release, the Release workflow will build and deploy."
